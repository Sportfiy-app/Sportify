name: ðŸŒ³ Master Pipeline - Complete CI/CD Tree

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  FLUTTER_VERSION: '3.27.0'
  DATABASE_URL: postgresql://sportify:sportify@localhost:5432/sportify_test

jobs:
  # ============================================
  # ðŸŒ³ PIPELINE TREE VISUALIZATION
  # ============================================
  show-pipeline-tree:
    name: ðŸŒ³ Complete Pipeline Tree
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Display Complete Pipeline Tree
        run: |
          echo "# ðŸŒ³ Complete CI/CD Pipeline Tree" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> $GITHUB_STEP_SUMMARY
          echo "â”‚              ðŸŒ³ MASTER PIPELINE                          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> $GITHUB_STEP_SUMMARY
          echo "                         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "                         â–¼" >> $GITHUB_STEP_SUMMARY
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         ðŸ“‹ VALIDATION & QUALITY CHECKS                   â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         (Run in parallel)                               â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  Backend CI      â”‚    â”‚  Frontend CI     â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â”œâ”€ Lint         â”‚    â”‚  â”œâ”€ Analyze      â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â”œâ”€ Type Check   â”‚    â”‚  â”œâ”€ Tests        â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â”œâ”€ Tests        â”‚    â”‚  â”œâ”€ Build Androidâ”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â”œâ”€ Build        â”‚    â”‚  â””â”€ Build iOS    â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â””â”€ Security     â”‚    â”‚                  â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> $GITHUB_STEP_SUMMARY
          echo "                         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "                         â–¼" >> $GITHUB_STEP_SUMMARY
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         ðŸ§ª INTEGRATION & FUNCTIONAL TESTS               â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         (Depends on Validation)                          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  E2E Tests      â”‚    â”‚  Functional      â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â”œâ”€ Backend E2E â”‚    â”‚  Tests           â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â””â”€ Frontend E2Eâ”‚    â”‚  â””â”€ API Tests    â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> $GITHUB_STEP_SUMMARY
          echo "                         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "                         â–¼" >> $GITHUB_STEP_SUMMARY
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         ðŸ” CODE QUALITY & SECURITY                      â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         (Depends on Validation)                         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  Code Quality    â”‚    â”‚  Dependency      â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â”œâ”€ SonarCloud   â”‚    â”‚  Review          â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â”œâ”€ Snyk         â”‚    â”‚  â””â”€ Security     â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â”‚  â””â”€ Quality      â”‚    â”‚                  â”‚          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> $GITHUB_STEP_SUMMARY
          echo "                         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "                         â–¼" >> $GITHUB_STEP_SUMMARY
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         ðŸš€ DEPLOYMENT ENVIRONMENTS                       â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         (Depends on all tests passing)                  â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  ðŸŒ¿ Review (PR)                                         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚     â”œâ”€ Backend â†’ Review                                 â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚     â””â”€ Frontend â†’ Review (Netlify)                     â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         â–¼" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  ðŸŒ¿ Staging (develop)                                   â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚     â”œâ”€ Backend â†’ Staging (Heroku)                       â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚     â””â”€ Frontend â†’ Staging (Netlify)                     â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚         â–¼ (depends on Staging)" >> $GITHUB_STEP_SUMMARY
          echo "â”‚  ðŸš€ Production (main)                                    â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚     â”œâ”€ Backend â†’ Production (Heroku)                    â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”‚     â””â”€ Frontend â†’ Production (Netlify/Firebase)         â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ðŸ“‹ VALIDATION & QUALITY CHECKS
  # ============================================
  
  # Backend CI Jobs
  backend-lint:
    name: ðŸ“‹ Backend â†’ Lint & Format
    runs-on: ubuntu-latest
    needs: show-pipeline-tree
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check formatting
        run: |
          npm run format -- --check || (echo "âŒ Code formatting check failed. Run 'npm run format' to fix." && exit 1)

  backend-type-check:
    name: ðŸ“‹ Backend â†’ TypeScript Check
    runs-on: ubuntu-latest
    needs: show-pipeline-tree
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npm run type-check

  backend-tests:
    name: ðŸ“‹ Backend â†’ Unit Tests
    runs-on: ubuntu-latest
    needs: show-pipeline-tree
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  backend-build:
    name: ðŸ“‹ Backend â†’ Build
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-type-check, backend-tests]
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build project
        run: npm run build

  backend-security:
    name: ðŸ“‹ Backend â†’ Security Audit
    runs-on: ubuntu-latest
    needs: show-pipeline-tree
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Run security audit
        continue-on-error: true
        run: npm audit --audit-level=moderate

  # Frontend CI Jobs
  frontend-analyze:
    name: ðŸ“‹ Frontend â†’ Analyze & Lint
    runs-on: ubuntu-latest
    needs: show-pipeline-tree

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

  frontend-tests:
    name: ðŸ“‹ Frontend â†’ Unit Tests
    runs-on: ubuntu-latest
    needs: show-pipeline-tree

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  frontend-build-android:
    name: ðŸ“‹ Frontend â†’ Build Android
    runs-on: ubuntu-latest
    needs: [frontend-analyze, frontend-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

  frontend-build-ios:
    name: ðŸ“‹ Frontend â†’ Build iOS
    runs-on: macos-latest
    needs: [frontend-analyze, frontend-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build iOS
        run: flutter build ios --release --no-codesign

  # ============================================
  # ðŸ§ª INTEGRATION & FUNCTIONAL TESTS
  # ============================================

  e2e-backend:
    name: ðŸ§ª E2E â†’ Backend Tests
    runs-on: ubuntu-latest
    needs: [backend-build, backend-tests]
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: sportify
          POSTGRES_PASSWORD: sportify
          POSTGRES_DB: sportify_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: npx prisma migrate deploy

      - name: Run E2E tests
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: npm run test:e2e

  e2e-frontend:
    name: ðŸ§ª E2E â†’ Frontend Tests
    runs-on: ubuntu-latest
    needs: [frontend-build-android, frontend-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run E2E tests
        run: |
          if [ -d "integration_test" ] && [ "$(ls -A integration_test)" ]; then
            flutter test integration_test/ -d chrome
          else
            echo "No integration tests found. Skipping E2E tests."
          fi

  functional-tests:
    name: ðŸ§ª Functional â†’ API Tests
    runs-on: ubuntu-latest
    needs: [backend-build, e2e-backend]
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: sportify
          POSTGRES_PASSWORD: sportify
          POSTGRES_DB: sportify_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: npx prisma migrate deploy

      - name: Run functional tests
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: npm run test:functional || echo "Functional tests not configured yet"

  # ============================================
  # ðŸ” CODE QUALITY & SECURITY
  # ============================================

  code-quality:
    name: ðŸ” Code Quality â†’ SonarCloud
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build-android]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run SonarCloud Scan
        continue-on-error: true
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-review:
    name: ðŸ” Security â†’ Dependency Review
    runs-on: ubuntu-latest
    needs: show-pipeline-tree
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  # ============================================
  # ðŸš€ DEPLOYMENT ENVIRONMENTS
  # ============================================

  # Review Environment
  determine-review:
    name: ðŸŒ¿ Review â†’ Determine
    runs-on: ubuntu-latest
    needs: [e2e-backend, functional-tests]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      pr-number: ${{ github.event.pull_request.number }}
    steps:
      - name: Check if should deploy
        id: check
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ github.event.action }}" == "closed" ]; then
              echo "should-deploy=false" >> $GITHUB_OUTPUT
            else
              echo "should-deploy=true" >> $GITHUB_OUTPUT
            fi
          else
            # For main branch, always deploy to review for testing
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy-review-backend:
    name: ðŸŒ¿ Review â†’ Backend
    runs-on: ubuntu-latest
    needs: [show-pipeline-tree, determine-review]
    if: |
      always() &&
      needs.determine-review.result == 'success' &&
      needs.determine-review.outputs.should-deploy == 'true'
    environment:
      name: Review
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build project
        run: npm run build

      - name: Deploy to Review
        run: |
          echo "ðŸš€ Backend deployed to Review environment for PR #${{ github.event.pull_request.number }}"

  deploy-review-frontend:
    name: ðŸŒ¿ Review â†’ Frontend (Netlify)
    runs-on: ubuntu-latest
    needs: [show-pipeline-tree, determine-review]
    if: |
      always() &&
      needs.determine-review.result == 'success' &&
      needs.determine-review.outputs.should-deploy == 'true'
    environment:
      name: Review

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build web (Review)
        run: |
          flutter build web --release \
            --dart-define=ENVIRONMENT=review \
            --dart-define=API_URL=https://review-api.sportify.app

      - name: Deploy to Netlify (Review)
        continue-on-error: true
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './build/web'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy Preview for PR #${{ github.event.pull_request.number }}"
          enable-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_STAGING_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_STAGING_SITE_ID }}

  # Staging Environment
  determine-staging:
    name: ðŸŒ¿ Staging â†’ Determine
    runs-on: ubuntu-latest
    needs: [e2e-backend, functional-tests]
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')) ||
      (github.event_name == 'workflow_dispatch')
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - name: Check if should deploy
        id: check
        run: echo "should-deploy=true" >> $GITHUB_OUTPUT

  deploy-staging-backend:
    name: ðŸŒ¿ Staging â†’ Backend (Heroku)
    runs-on: ubuntu-latest
    needs: [show-pipeline-tree, determine-staging]
    if: |
      always() &&
      needs.determine-staging.result == 'success' &&
      needs.determine-staging.outputs.should-deploy == 'true'
    environment:
      name: Staging
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build project
        run: npm run build

      - name: Deploy to Heroku (Staging)
        continue-on-error: true
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_STAGING_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_STAGING_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: "."
          procfile: "web: cd backend && npm start"
          usedocker: false
          buildpack: "heroku/nodejs"

  deploy-staging-frontend:
    name: ðŸŒ¿ Staging â†’ Frontend (Netlify)
    runs-on: ubuntu-latest
    needs: [show-pipeline-tree, determine-staging]
    if: |
      always() &&
      needs.determine-staging.result == 'success' &&
      needs.determine-staging.outputs.should-deploy == 'true'
    environment:
      name: Staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build web (Staging)
        run: |
          flutter build web --release \
            --dart-define=ENVIRONMENT=staging \
            --dart-define=API_URL=https://staging-api.sportify.app

      - name: Deploy to Netlify (Staging)
        continue-on-error: true
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './build/web'
          production-branch: develop
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy to Staging from GitHub Actions - ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_STAGING_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_STAGING_SITE_ID }}

  # Production Environment
  determine-production:
    name: ðŸš€ Production â†’ Determine
    runs-on: ubuntu-latest
    needs: [e2e-backend, functional-tests]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch')
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - name: Check if should deploy
        id: check
        run: echo "should-deploy=true" >> $GITHUB_OUTPUT

  deploy-production-backend:
    name: ðŸš€ Production â†’ Backend (Heroku) [depends on Staging]
    runs-on: ubuntu-latest
    needs: [show-pipeline-tree, determine-production, deploy-staging-backend]
    if: |
      needs.determine-production.outputs.should-deploy == 'true' &&
      (needs.deploy-staging-backend.result == 'success' || needs.deploy-staging-backend.result == 'skipped')
    environment:
      name: Production
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build project
        run: npm run build

      - name: Deploy to Heroku (Production)
        continue-on-error: true
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: "."
          procfile: "web: cd backend && npm start"
          usedocker: false
          buildpack: "heroku/nodejs"

      - name: Install Heroku CLI
        continue-on-error: true
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Set Heroku API key
        continue-on-error: true
        run: |
          mkdir -p ~/.netrc
          echo "machine api.heroku.com" >> ~/.netrc
          echo "  login ${{ secrets.HEROKU_EMAIL }}" >> ~/.netrc
          echo "  password ${{ secrets.HEROKU_API_KEY }}" >> ~/.netrc
          chmod 600 ~/.netrc

      - name: Run database migrations
        continue-on-error: true
        run: |
          heroku run npx prisma migrate deploy -a ${{ secrets.HEROKU_APP_NAME }} || echo "Migrations already up to date"

      - name: Restart Heroku app
        continue-on-error: true
        run: |
          heroku restart -a ${{ secrets.HEROKU_APP_NAME }}

  deploy-production-frontend:
    name: ðŸš€ Production â†’ Frontend (Netlify/Firebase) [depends on Staging]
    runs-on: ubuntu-latest
    needs: [show-pipeline-tree, determine-production, deploy-staging-frontend]
    if: |
      needs.determine-production.outputs.should-deploy == 'true' &&
      (needs.deploy-staging-frontend.result == 'success' || needs.deploy-staging-frontend.result == 'skipped')
    environment:
      name: Production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build web (Production)
        run: |
          flutter build web --release \
            --dart-define=ENVIRONMENT=production \
            --dart-define=API_URL=https://api.sportify.app

      - name: Deploy to Firebase Hosting (Production)
        continue-on-error: true
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy to Netlify (Production)
        continue-on-error: true
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './build/web'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy to Production from GitHub Actions - ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # ============================================
  # ðŸ“Š COMPLETE PIPELINE SUMMARY
  # ============================================
  pipeline-summary:
    name: ðŸ“Š Complete Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      - show-pipeline-tree
      - backend-lint
      - backend-type-check
      - backend-tests
      - backend-build
      - backend-security
      - frontend-analyze
      - frontend-tests
      - frontend-build-android
      - frontend-build-ios
      - e2e-backend
      - e2e-frontend
      - functional-tests
      - code-quality
      - dependency-review
      - deploy-review-backend
      - deploy-review-frontend
      - deploy-staging-backend
      - deploy-staging-frontend
      - deploy-production-backend
      - deploy-production-frontend
    if: always()

    steps:
      - name: Generate complete pipeline summary
        run: |
          echo "# ðŸŒ³ Complete CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Validation & Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend â†’ Lint | ${{ needs.backend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend â†’ Type Check | ${{ needs.backend-type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend â†’ Tests | ${{ needs.backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend â†’ Build | ${{ needs.backend-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend â†’ Security | ${{ needs.backend-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend â†’ Analyze | ${{ needs.frontend-analyze.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend â†’ Tests | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend â†’ Build Android | ${{ needs.frontend-build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend â†’ Build iOS | ${{ needs.frontend-build-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª Integration & Functional Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E â†’ Backend | ${{ needs.e2e-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E â†’ Frontend | ${{ needs.e2e-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Functional â†’ API Tests | ${{ needs.functional-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Code Quality & Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality â†’ SonarCloud | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security â†’ Dependency Review | ${{ needs.dependency-review.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Deployment Environments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Backend | Frontend | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Review | ${{ needs.deploy-review-backend.result }} | ${{ needs.deploy-review-frontend.result }} | ${{ needs.deploy-review-backend.result == 'success' && needs.deploy-review-frontend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Staging | ${{ needs.deploy-staging-backend.result }} (Heroku) | ${{ needs.deploy-staging-frontend.result }} (Netlify) | ${{ needs.deploy-staging-backend.result == 'success' && needs.deploy-staging-frontend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Production | ${{ needs.deploy-production-backend.result }} (Heroku) | ${{ needs.deploy-production-frontend.result }} (Netlify/Firebase) | ${{ needs.deploy-production-backend.result == 'success' && needs.deploy-production-frontend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ³ Pipeline Tree Structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ³ Master Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ ðŸ“‹ Validation & Quality" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â”œâ”€â”€ Backend CI (Lint, Type, Tests, Build, Security)" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â””â”€â”€ Frontend CI (Analyze, Tests, Build Android/iOS)" >> $GITHUB_STEP_SUMMARY
          echo "â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ ðŸ§ª Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â”œâ”€â”€ E2E Backend" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â”œâ”€â”€ E2E Frontend" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â””â”€â”€ Functional Tests" >> $GITHUB_STEP_SUMMARY
          echo "â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ ðŸ” Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â”œâ”€â”€ SonarCloud" >> $GITHUB_STEP_SUMMARY
          echo "â”‚   â””â”€â”€ Dependency Review" >> $GITHUB_STEP_SUMMARY
          echo "â”‚" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€ ðŸš€ Deployment" >> $GITHUB_STEP_SUMMARY
          echo "    â”œâ”€â”€ ðŸŒ¿ Review (PR)" >> $GITHUB_STEP_SUMMARY
          echo "    â”‚   â”œâ”€â”€ Backend" >> $GITHUB_STEP_SUMMARY
          echo "    â”‚   â””â”€â”€ Frontend (Netlify)" >> $GITHUB_STEP_SUMMARY
          echo "    â”‚" >> $GITHUB_STEP_SUMMARY
          echo "    â”œâ”€â”€ ðŸŒ¿ Staging (develop)" >> $GITHUB_STEP_SUMMARY
          echo "    â”‚   â”œâ”€â”€ Backend (Heroku)" >> $GITHUB_STEP_SUMMARY
          echo "    â”‚   â””â”€â”€ Frontend (Netlify)" >> $GITHUB_STEP_SUMMARY
          echo "    â”‚       â”‚" >> $GITHUB_STEP_SUMMARY
          echo "    â”‚       â–¼ (depends on)" >> $GITHUB_STEP_SUMMARY
          echo "    â”‚" >> $GITHUB_STEP_SUMMARY
          echo "    â””â”€â”€ ðŸš€ Production (main)" >> $GITHUB_STEP_SUMMARY
          echo "        â”œâ”€â”€ Backend (Heroku)" >> $GITHUB_STEP_SUMMARY
          echo "        â””â”€â”€ Frontend (Netlify/Firebase)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

